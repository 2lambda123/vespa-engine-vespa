search neuralnet {

    document neuralnet {

        field pinned type int {
            indexing: attribute
        }

        field createdAt type long {
            indexing: attribute
        }

        field updatedAt type long {
            indexing: attribute
        }

        field upVoteCount type int {
            indexing: attribute
        }

        field downVoteCount type int {
            indexing: attribute
        }

        field abuseVoteCount type int {
            indexing: attribute
        }

        field replyCount type int {
            indexing: attribute
        }

        field uniqueReplyAuthorCount type int {
            indexing: attribute
        }

        field replyTo type string {
            indexing: attribute
        }

        field markedAsAbuseAt type long {
            indexing: attribute
        }

        field normalizedTextScore type float {
            indexing: attribute
        }

        field ericScore type float {
            indexing: attribute
        }

        field toxicity type float {
            indexing: attribute
        }

        field relevance type float {
            indexing: attribute
        }

        field normalizedCommunityScore type float {
            indexing: attribute
        }

        field lastActivityAt type long {
            indexing: attribute
        }

        field hsScore type double {
            indexing: attribute
        }

    }

    rank-profile defaultRankProfile inherits default {

        constants {
            maxSignedSixtyFourBitInteger: 9223372036854775807
        }

        macro log10_1p(x) {
            expression: log10(x+1)
        }

        macro textScoreToUse() {
            expression: if(isNan(attribute(normalizedTextScore)) == 1, 0, attribute(normalizedTextScore))
        }

        macro ericScoreToUse() {
            expression: if(isNan(attribute(ericScore)) == 1, 0, attribute(ericScore))
        }

        macro replyCountToUse() {
            expression: if(isNan(attribute(replyCount)) == 1, 0, if(attribute(replyCount) < 0, 0, attribute(replyCount)))
        }

        macro uniqueReplyCountToUse() {
            expression: if(isNan(attribute(uniqueReplyAuthorCount)) == 1, 0, if(attribute(uniqueReplyAuthorCount) < 0, 0, attribute(uniqueReplyAuthorCount)))
        }

        macro upVoteCountToUse() {
            expression: if(isNan(attribute(upVoteCount)) == 1, 0, if(attribute(upVoteCount) < 0, 0, attribute(upVoteCount)))
        }

        macro downVoteCountToUse() {
            expression: if(isNan(attribute(downVoteCount)) == 1, 0, if(attribute(downVoteCount) < 0, 0, attribute(downVoteCount)))
        }

        macro abuseVoteCountToUse() {
            expression: if(isNan(attribute(abuseVoteCount)) == 1, 0, if(attribute(abuseVoteCount) < 0, 0, attribute(abuseVoteCount)))
        }

        macro totalPositiveReactions() {
            expression: uniqueReplyCountToUse + query(voteToReplyRatio) * (upVoteCountToUse - downVoteCountToUse) - abuseVoteCountToUse
        }

        macro totalvote() {
            expression: query(reportabuseweight) * abuseVoteCountToUse + downVoteCountToUse + query(replyweight) * uniqueReplyCountToUse + upVoteCountToUse
        }

        macro phat() {
            expression: if (totalvote == 0, 0, ( query(replyweight) * uniqueReplyCountToUse + upVoteCountToUse) / totalvote)
        }

        macro newCommunityScoreToUse() {
            expression: if (totalPositiveReactions > 0, log10(totalPositiveReactions), 0)
        }

        macro hsScoreToUse() {
            expression: attribute(hsScore)
        }

        macro toxicityScoreToUse() {
            expression: if (isNan(attribute(toxicity)) == 1, 0.6, attribute(toxicity))
        }

        macro relevanceScoreToUse() {
            expression: if (isNan(attribute(relevance)) == 1, 0.254, attribute(relevance))
        }

        macro freshnessToUse() {
            expression: if (freshness(createdAt).logscale < 0.01, 0.01, freshness(createdAt).logscale)
        }

        macro rankedAt() {
            expression: now
        }

        macro createdAtToUse() {
            expression: if(isNan(attribute(createdAt)) == 1, rankedAt, attribute(createdAt))
        }

        macro lastActivityAtToUse() {
            expression: if(isNan(attribute(lastActivityAt)) == 1, attribute(createdAt), attribute(lastActivityAt))
        }

        macro markedAsAbuseAtToUse() {
            expression: if(isNan(attribute(markedAsAbuseAt)) == 1, maxSignedSixtyFourBitInteger, attribute(markedAsAbuseAt))
        }

        macro timeDecayToUse() {
            expression: pow(2, 0 - ((rankedAt - createdAtToUse) / query(decay)))
        }

        macro commentOverallScore() {
            expression: query(textweight) * textScoreToUse  + query(communityweight) * newCommunityScoreToUse
        }

        macro pinScore() {
            expression: if(isNan(attribute(pinned)) == 1, 0, query(pinweight) * attribute(pinned))
        }

        macro freshnessRank() {
            expression: nativeRank + freshness(createdAt)
        }

        first-phase {
            expression: nativeRank
        }

    }

    rank-profile neuralNetworkProfile inherits defaultRankProfile {
        macro nn_input() {
            expression {
                concat(log10_1p(abuseVoteCountToUse),
                concat(log10_1p(downVoteCountToUse),
                concat(log10_1p(uniqueReplyCountToUse),
                concat(log10_1p(upVoteCountToUse),
                concat(phat,
                concat(log10_1p(totalvote),
                concat(hsScoreToUse,
                concat(timeDecayToUse,
                toxicityScoreToUse, x), x), x), x), x), x), x), x)
            }
        }

        macro get_model_weights(field) {
            expression: if(query(field) == 0, constant(field), query(field))
        }

        macro layer_0() {
            expression: elu(xw_plus_b(nn_input, get_model_weights(W_0), get_model_weights(b_0), x))
        }
        macro layer_1() {
            expression: elu(xw_plus_b(layer_0, get_model_weights(W_1), get_model_weights(b_1), hidden))
        }
        macro layer_out() {
            expression: sum(xw_plus_b(layer_1, get_model_weights(W_out), get_model_weights(b_out), out))
        }
        first-phase {
            expression: freshnessRank
        }
        second-phase {
            expression: layer_out
            rerank-count: 2000
        }

    }

    constant W_0 {
        file: neural-network-201805/W_0.json
        type: tensor(x[9],hidden[9])
    }
    constant b_0 {
        file: neural-network-201805/b_0.json
        type: tensor(hidden[9])
    }
    constant W_1 {
        file: neural-network-201805/W_1.json
        type: tensor(hidden[9],out[9])
    }
    constant b_1 {
        file: neural-network-201805/b_1.json
        type: tensor(out[9])
    }
    constant W_out {
        file: neural-network-201805/W_out.json
        type: tensor(out[9])
    }
    constant b_out {
        file: neural-network-201805/b_out.json
        type: tensor(out[1])
    }

}