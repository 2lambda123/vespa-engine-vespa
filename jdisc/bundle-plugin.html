---
# Copyright 2016 Yahoo Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.
title: "Bundle Plugin"
---

<p>
This document explains usage of the <code>bundle-plugin</code>, which
is used to package components for
the <a href="container-components.html">Container</a>.
</p>



<h1 id="building-bundles-with-maven">Building Bundles with Maven</h1>
<p>
We recommend that you build your bundles using maven and our
bundle plugin. To get started, clone a <a href="../develop-with-vespa.html">sample project</a>.
The bundle is generated by running <em>mvn install</em>. It can
then be found in the target directory, and will have the suffix
<em>-deploy.jar</em>. Alternatively, if you already have a pom
file, you can change the following:
</p>

<ul>
  <li><p>Change <em>packaging</em>:</p>
      <pre class="brush: xml">&lt;packaging&gt;container-plugin&lt;/packaging&gt;</pre>
  </li>

  <li><p>Add <em>bundle-plugin</em> dependency:</p>
<pre class="brush: xml">
&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;com.yahoo.vespa&lt;/groupId&gt;
      &lt;artifactId&gt;bundle-plugin&lt;/artifactId&gt;
      &lt;version&gt;<em>vespa-version</em>&lt;/version&gt;
      &lt;extensions&gt;true&lt;/extensions&gt;
    &lt;/plugin&gt;
    &hellip;
</pre>
  </li>
  <li><p>Add <em>container-dev</em> dependency:</p>
<pre class="brush: xml">
&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;com.yahoo.vespa&lt;/groupId&gt;
    &lt;artifactId&gt;container-dev&lt;/artifactId&gt;
    &lt;version&gt;<em>vespa-version</em>&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
  &lt;/dependency&gt;
  &hellip;
</pre>
  </li>
</ul>



<h1 id="including-external-libraries">Including Third-Party Libraries</h1>
<p>
External dependencies can be included into the bundle by specifying
them as dependencies:
</p>

<pre class="brush: xml">
&lt;dependency&gt;
  &lt;groupId&gt;org.json&lt;/groupId&gt;
  &lt;artifactId&gt;json&lt;/artifactId&gt;
  &lt;version&gt;20090211&lt;/version&gt;
&lt;/dependency&gt;
</pre>

<p>
All packages in the library will then be available for use.
If the external dependency is an OSGi bundle, you can opt to deploy it
instead of including it into the bundle by setting the scope to
provided:
</p>

<pre class="brush: xml">
&lt;dependency&gt;
  &lt;groupId&gt;org.json&lt;/groupId&gt;
  &lt;artifactId&gt;json&lt;/artifactId&gt;
  &lt;version&gt;20090211&lt;/version&gt;
  <strong>&lt;scope&gt;provided&lt;/scope&gt;</strong>
&lt;/dependency&gt;
</pre>

<p>
You must then deploy the external dependency along with your bundle.
Only packages exported by the author of the library will then be
available for use (see the section below).
</p>



<h1 id="exporting-importing-and-including-packages-from-bundles">Exporting, Importing and Including Packages in Bundles</h1>

<p>
OSGi features information hiding &mdash; by default all the classes
used inside a bundle are invisible from the outside.  Also, the bundle
will by default only see (all) the packages in the Java and Container
+ Vespa APIs. If any other package is needed by the bundle, then it
must happen in one of three ways:
</p>

<ul>
  <li>Some additional packages are exported by the container and may
      be <em>imported</em> explicitly by a bundle</li>
  <li>In addition, any deployed bundle may export packages on its own,
      which may then be imported by another bundle</li>
  <li>Finally, the bundle may include its own JAR libraries</li>
</ul>

<p>
You can export packages from your bundle by annotating the package.
To export <em>com.mydomain.mypackage</em> for example, create the
file <em>package-info.java</em> in the package directory with the
following content:
</p>

<pre class="brush: java">
@ExportPackage(version = @Version(major=1, minor=0, micro=0))
package com.mydomain.mypackage;

import com.yahoo.osgi.annotation.ExportPackage;
import com.yahoo.osgi.annotation.Version;
</pre>

<p>
The Maven plugin will place such information in the manifest of the
plugin JAR built to be picked up by the Container.
</p>

<p>
Note that this may also be used with bundles that do not contain any
searchers but libraries used by other searchers &mdash; a bundle may
just exist to export some libraries and never have any searchers
instantiated.
</p>

<p>
Bundles may <em>import</em> packages (exported by some other bundle or
by the container).  The maven plugin will automatically import any
package used from bundles it compiles against(i.e. maven dependencies
with scope provided).
</p>

<p>
As mentioned above, each exported package has a version associated
with it.  Similary, an import of a package has a version range
associated with it.  The version range determines which exported
packages can be used.  The range used by the maven plugin is the
current version(i.e. the version of the package available at compile
time) up to the next major version (not including).
</p>

<p>
To learn more about OSGi manifests and bundle packaging (e.g how to
include Java libraries and native code), please refer to the OSGi spec
at <a href="http://osgi.org">the OSGi home page</a>.
</p>

<p>
More details in <a href="#troubleshooting">troubleshooting</a>.
</p>



<h1 id="configuration">Configuring the Bundle-Plugin</h1>

<p>
The bundle plugin can be optionally configured to tailor the resulting
bundle to specific needs.
</p>

<pre class="brush: xml">
&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;com.yahoo.vesp&lt;/groupId&gt;
        &lt;artifactId&gt;bundle-plugin&lt;/artifactId&gt;
        &lt;version&gt;vespa-version&lt;/version&gt;
        &lt;extensions&gt;true&lt;/extensions&gt;
        &lt;configuration&gt;
          &lt;discApplicationClass&gt;&hellip;&lt;/discApplicationClass&gt;
          &lt;discPreInstallBundle&gt;&hellip;&lt;/discPreInstallBundle&gt;
          &lt;bundleVersion&gt;&hellip;&lt;/bundleVersion&gt;
          &lt;bundleSymbolicName&gt;&hellip;&lt;/bundleSymbolicName&gt;
          &lt;bundleActivator&gt;&hellip;&lt;/bundleActivator&gt;
          &lt;configGenVersion&gt;&hellip;&lt;/configGenVersion&gt;
          &lt;configModels&gt;&hellip;&lt;/configModels&gt;
        &lt;/configuration&gt;
    &lt;/plugin&gt;
    &hellip;
</pre>

<p>
Description for the various config options:
</p>

<ul>
  <li><strong>discApplicationClass:</strong> The fully qualified class
      name of the Application to be started by JDisc.</li>
  <li><strong>discPreInstallBundle:</strong> The name of the bundles
      that jDISC must pre-install.</li>
  <li><strong>bundleVersion:</strong> The version of this
      bundle. Defaults to the Maven project version.</li>
  <li><strong>bundleSymbolicName:</strong> The symbolic name of this
      bundle. Defaults to the Maven artifact ID.</li>
  <li><strong>bundleActivator:</strong> The fully qualified class name
      of the bundle activator.</li>
  <li><strong>configGenVersion:</strong> The version of
  <em>com.yahoo.vespa.configlib.config-class-plugin</em> that will be used to
  generate config classes.</li>
  <li><strong>configModels:</strong> List of config models.</li>
</ul>


<h1 id="troubleshooting">Troubleshooting</h1>
<p>
A package <em>p</em> is imported if all of the following holds:
<ol>
<li>You're using a class in <em>p</em> directly (i.e. not with reflection) in your
bundle</li>
<li>There's no classes in your bundle that is in <em>p</em></li>
<li>There's a bundle that exports <em>p</em>, and you're compiling against this bundle</li>
</ol>
To debug, run
<pre class="brush: cli">
mvn -X package
</pre>
and look at Defined packages (=packages in your bundle), Exported packages of
dependencies, Referenced packages(= packages you use).
A package is imported if it is in Exported packages and Referenced packages but
not in Defined packages.
</p>


