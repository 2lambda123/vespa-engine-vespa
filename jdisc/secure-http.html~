<!DOCTYPE html>
<html lang="en">

<head>
  <title>Secure the HTTP interface</title>
  <link rel="stylesheet" href="http://vespa.corp.yahoo.com/css/vespadoc-standalone.css" />
  <meta name="date"    content="August 2014" />
  <meta name="authors" content="tonyv, musum, kraune" />
</head>
<body>

<p class="ingress">
This document aims to help you securing your service by using certificates and/or SSL
</p>

<h1 id="authentication">Authentication using YCA</h1>
<p>
The JDisc Container supports authentication of incoming requests
using <a href="http://twiki.corp.yahoo.com/view/WebServices/YCA">YCA</a>. This
is achieved through the use
of <a href="http://dist.corp.yahoo.com/by-package/jdisc_http_filters/">YCA
filter</a>:
</p>

<pre>
&lt;jdisc version="1.0"&gt;
  &lt;http&gt;
    &lt;filtering&gt;
      &lt;request-chain id="security-chain"&gt;
        &lt;filter id="com.yahoo.jdisc.http.filter.security.YCAFilter" bundle="yahoo.yinst.jdisc_http_filters"&gt;
          &lt;filter-config&gt;
            &lt;yca.appid.allow&gt;yahoo.vespa_factory.yca_test&lt;/yca.appid.allow&gt;
            &lt;yca.allowAny&gt;false&lt;/yca.allowAny&gt;
            &lt;yca.optional&gt;false&lt;/yca.optional&gt;
          &lt;/filter-config&gt;
        &lt;/filter&gt;
        &lt;binding&gt;http://*/*&lt;/binding&gt;
      &lt;/request-chain&gt;
    &lt;/filtering&gt;

    &lt;server id="main-server" port="4080" /&gt;
  &lt;/http&gt;
  &hellip;
</pre>

<p> For an explanation of the config parameters, please refer to <a
 href="http://twiki.corp.yahoo.com/view/Platform/WSTechYapacheModWebService#YCA_45related_directives">YCA-related
directives</a>.

<p class="alert alert-success">
  Please take care when modifying RolesDB, ref <a href="https://jira.corp.yahoo.com/browse/ROLESDB-286">ROLESDB-286</a>
  (too large role hierarchy) - check with Vespa team.
</p>

<p>
YCA authentication information can be accessed from handlers and
searchers by examining the request attributes.  For searchers, they
are accessed as
follows: <code>query.getRequest().getAttributes()</code>.
</p>

<p>
Interesting keys include:
</p>

<dl>
<dt>yjava.filter.yca.YCAFilterLogic</dt>
<dd>
  <ul>
    <li>REQUEST_ATTRIBUTE_AUTHENTICATED</li>
    <li>REQUEST_ATTRIBUTE_CLIENT_APP_ID</li>
    <li>REQUEST_ATTRIBUTE_CLIENT_USER_ID</li>
  </ul>
</dd>
</dl>

<p class="alert alert-success"> Note that there are internal HTTP status pages that are accessed by internal services to fetch state and metric information. If you enable YCA filters you should add the following:</p>
<pre>
&lt;request-chain id="nonyca-request-chain" inherits="yca-request-chain"excludes="com.yahoo.jdisc.http.filter.security.YCAFilter"&gt;  
    &lt;binding&gt;http://*/state/*&lt;/binding&gt;
    &lt;binding&gt;http://*/status.html&lt;/binding&gt; 
    &lt;binding&gt;http://*/ApplicationStatus&lt;/binding&gt;
    &lt;binding&gt;https://*/state/*&lt;/binding&gt;
    &lt;binding&gt;https://*/status.html&lt;/binding&gt;
    &lt;binding&gt;https://*/ApplicationStatus&lt;/binding&gt;
&lt;/request-chain&gt;
</pre>


<h1 id="ssl">SSL</h1>
<p>
Please refer to <a href="http-server-and-filters.html">HTTP server and filters</a>
for generic HTTP server configuration - below is an example of how to set up SSL.
</p>

<p class="alert alert-success">Please note that using SSL requires Jetty -
explicitly enable it on the jdisc element</p>

<pre>
&lt;jdisc version="1.0" jetty="true"&gt;
  &lt;http&gt;
    &lt;server id="main-server" port="5000"&gt;
      &lt;config name="container.jdisc.config.http-server"&gt;
        &lt;ssl&gt;
          &lt;enabled&gt;true&lt;/enabled&gt;
          &lt;keyStoreType&gt;JKS&lt;/keyStoreType&gt;
          &lt;keyStorePath&gt;/home/y/conf/jdisc_container/keyStore.jks&lt;/keyStorePath&gt;
          &lt;trustStoreType&gt;JKS&lt;/trustStoreType&gt;
          &lt;trustStorePath&gt;/home/y/conf/jdisc_container/trustStore.jks&lt;/trustStorePath&gt;
          &lt;keyDBKey&gt;jdisc_container&lt;/keyDBKey&gt;
          &lt;sslKeyManagerFactoryAlgorithm&gt;SunX509&lt;/sslKeyManagerFactoryAlgorithm&gt;
          &lt;protocol&gt;TLS&lt;/protocol&gt;
        &lt;/ssl&gt;
      &lt;/config&gt;
    &lt;/server&gt;
  &lt;/http&gt;
&lt;/jdisc&gt;
</pre>

<p>
Finally, review the <a href="http://git.corp.yahoo.com/vespa/vespa/blob/master/jdisc_http_service/src/main/resources/configdefinitions/jdisc.http.connector.def?view=markup">full list of config options</a>.
</p>

</body>
</html>
